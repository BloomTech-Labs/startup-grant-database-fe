{"ast":null,"code":"'use strict';\n\nexports.__esModule = true;\nexports.go = undefined;\nexports.isSuccess = isSuccess;\nexports.isDone = isDone;\nexports.hasError = hasError;\n\nvar _immutable = require('immutable');\n\nvar _data_utils = require('./utils/data_utils');\n\nvar _index = require('./core/index');\n\nvar l = _interopRequireWildcard(_index);\n\nvar _index2 = require('./store/index');\n\nfunction _interopRequireWildcard(obj) {\n  if (obj && obj.__esModule) {\n    return obj;\n  } else {\n    var newObj = {};\n\n    if (obj != null) {\n      for (var key in obj) {\n        if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key];\n      }\n    }\n\n    newObj.default = obj;\n    return newObj;\n  }\n}\n\nvar _dataFns = (0, _data_utils.dataFns)(['sync']),\n    get = _dataFns.get,\n    set = _dataFns.set;\n\nexports.default = function (m, key, opts) {\n  if (get(m, key) !== undefined) return m;\n  var status = opts.waitFn ? 'waiting' : !opts.conditionFn || opts.conditionFn(m) ? 'pending' : 'no';\n  return set(m, key, (0, _immutable.Map)({\n    conditionFn: opts.conditionFn,\n    errorFn: opts.errorFn,\n    recoverResult: opts.recoverResult,\n    syncStatus: status,\n    successFn: opts.successFn,\n    syncFn: opts.syncFn,\n    timeout: opts.timeout || 6000,\n    waitFn: opts.waitFn\n  }));\n};\n\nvar syncStatusKey = function syncStatusKey(key) {\n  return (global.Array.isArray(key) ? key : [key]).concat(['syncStatus']);\n};\n\nvar getStatus = function getStatus(m, key) {\n  return get(m, syncStatusKey(key));\n};\n\nvar setStatus = function setStatus(m, key, str) {\n  return set(m, syncStatusKey(key), str);\n};\n\nvar getProp = function getProp(m, key, name) {\n  return get(m, key).get(name);\n};\n\nvar findKeys = function findKeys(m) {\n  return m.reduce(function (r, v, k) {\n    var current = _immutable.Map.isMap(v) && v.has('syncStatus') ? [k] : [];\n    var nested = _immutable.Map.isMap(v) ? findKeys(v).map(function (x) {\n      return [k].concat(x);\n    }) : [];\n    return r.concat.apply(r, [current].concat([nested]));\n  }, []);\n};\n\nfunction removeKeys(m, keys) {\n  return keys.reduce(function (r, k) {\n    return r.deleteIn(syncStatusKey(k));\n  }, m);\n}\n\nvar process = function process(m, id) {\n  var keys = findKeys(get(m, [], (0, _immutable.Map)())); // TODO timeout\n\n  return keys.reduce(function (r, k) {\n    if (typeof getProp(r, k, 'syncFn') != 'function') return r;\n\n    if (getStatus(r, k) === 'pending') {\n      r = setStatus(r, k, 'loading');\n      var called = false;\n      getProp(r, k, 'syncFn')(r, function (error, result) {\n        if (called) return;\n        called = true;\n        setTimeout(function () {\n          (0, _index2.swap)(_index2.updateEntity, 'lock', id, function (m) {\n            var errorFn = getProp(r, k, 'errorFn');\n\n            if (error && typeof errorFn === 'function') {\n              setTimeout(function () {\n                return errorFn(m, error);\n              }, 0);\n            }\n\n            var recoverResult = getProp(m, k, 'recoverResult');\n\n            if (error && recoverResult === undefined) {\n              return handleError(m, k, error);\n            } else {\n              m = setStatus(m, k, 'ok');\n              return getProp(m, k, 'successFn')(m, error ? recoverResult : result);\n            }\n          });\n        }, 0);\n      });\n    } else if (getStatus(r, k) === 'waiting') {\n      if (getProp(r, k, 'waitFn')(r)) {\n        var conditionFn = getProp(r, k, 'conditionFn');\n        r = setStatus(r, k, !conditionFn || conditionFn(r) ? 'pending' : 'no');\n      }\n    }\n\n    return r;\n  }, m);\n};\n\nvar go = exports.go = function go(id) {\n  (0, _index2.observe)('sync', id, function (m) {\n    setTimeout(function () {\n      return (0, _index2.swap)(_index2.updateEntity, 'lock', id, process, id);\n    }, 0);\n  });\n};\n\nfunction isSuccess(m, key) {\n  return getStatus(m, key) === 'ok';\n}\n\nfunction isDone(m) {\n  var keys = findKeys(get(m, [], (0, _immutable.Map)()));\n  return keys.length > 0 && keys.reduce(function (r, k) {\n    return r && !isLoading(m, k);\n  }, true);\n}\n\nfunction hasError(m) {\n  var excludeKeys = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n  var keys = findKeys(removeKeys(get(m, [], (0, _immutable.Map)()), excludeKeys));\n  return keys.length > 0 && keys.reduce(function (r, k) {\n    return r || getStatus(m, k) === 'error';\n  }, false);\n}\n\nfunction isLoading(m, key) {\n  return ['loading', 'pending', 'waiting'].indexOf(getStatus(m, key)) > -1;\n}\n\nfunction handleError(m, key, error) {\n  var result = setStatus(m, key, 'error'); // TODO: this should be configurable for each sync\n\n  if (key !== 'sso') {\n    var stopError = new Error('An error occurred when fetching ' + key + ' data for Lock: ' + error.message);\n    stopError.code = 'sync';\n    stopError.origin = error;\n    result = l.stop(result, stopError);\n  }\n\n  return result;\n}","map":{"version":3,"sources":["/Users/jacksonmccomas/Documents/Lambda/labs/startup-grant-database-fe/grantly/node_modules/auth0-lock/lib/sync.js"],"names":["exports","__esModule","go","undefined","isSuccess","isDone","hasError","_immutable","require","_data_utils","_index","l","_interopRequireWildcard","_index2","obj","newObj","key","Object","prototype","hasOwnProperty","call","default","_dataFns","dataFns","get","set","m","opts","status","waitFn","conditionFn","Map","errorFn","recoverResult","syncStatus","successFn","syncFn","timeout","syncStatusKey","global","Array","isArray","concat","getStatus","setStatus","str","getProp","name","findKeys","reduce","r","v","k","current","isMap","has","nested","map","x","apply","removeKeys","keys","deleteIn","process","id","called","error","result","setTimeout","swap","updateEntity","handleError","observe","length","isLoading","excludeKeys","arguments","indexOf","stopError","Error","message","code","origin","stop"],"mappings":"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","sourcesContent":["'use strict';\n\nexports.__esModule = true;\nexports.go = undefined;\nexports.isSuccess = isSuccess;\nexports.isDone = isDone;\nexports.hasError = hasError;\n\nvar _immutable = require('immutable');\n\nvar _data_utils = require('./utils/data_utils');\n\nvar _index = require('./core/index');\n\nvar l = _interopRequireWildcard(_index);\n\nvar _index2 = require('./store/index');\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }\n\nvar _dataFns = (0, _data_utils.dataFns)(['sync']),\n    get = _dataFns.get,\n    set = _dataFns.set;\n\nexports.default = function (m, key, opts) {\n  if (get(m, key) !== undefined) return m;\n\n  var status = opts.waitFn ? 'waiting' : !opts.conditionFn || opts.conditionFn(m) ? 'pending' : 'no';\n\n  return set(m, key, (0, _immutable.Map)({\n    conditionFn: opts.conditionFn,\n    errorFn: opts.errorFn,\n    recoverResult: opts.recoverResult,\n    syncStatus: status,\n    successFn: opts.successFn,\n    syncFn: opts.syncFn,\n    timeout: opts.timeout || 6000,\n    waitFn: opts.waitFn\n  }));\n};\n\nvar syncStatusKey = function syncStatusKey(key) {\n  return (global.Array.isArray(key) ? key : [key]).concat(['syncStatus']);\n};\nvar getStatus = function getStatus(m, key) {\n  return get(m, syncStatusKey(key));\n};\nvar setStatus = function setStatus(m, key, str) {\n  return set(m, syncStatusKey(key), str);\n};\nvar getProp = function getProp(m, key, name) {\n  return get(m, key).get(name);\n};\n\nvar findKeys = function findKeys(m) {\n  return m.reduce(function (r, v, k) {\n    var current = _immutable.Map.isMap(v) && v.has('syncStatus') ? [k] : [];\n    var nested = _immutable.Map.isMap(v) ? findKeys(v).map(function (x) {\n      return [k].concat(x);\n    }) : [];\n    return r.concat.apply(r, [current].concat([nested]));\n  }, []);\n};\n\nfunction removeKeys(m, keys) {\n  return keys.reduce(function (r, k) {\n    return r.deleteIn(syncStatusKey(k));\n  }, m);\n}\n\nvar process = function process(m, id) {\n  var keys = findKeys(get(m, [], (0, _immutable.Map)()));\n  // TODO timeout\n  return keys.reduce(function (r, k) {\n    if (typeof getProp(r, k, 'syncFn') != 'function') return r;\n    if (getStatus(r, k) === 'pending') {\n      r = setStatus(r, k, 'loading');\n      var called = false;\n      getProp(r, k, 'syncFn')(r, function (error, result) {\n        if (called) return;\n        called = true;\n        setTimeout(function () {\n          (0, _index2.swap)(_index2.updateEntity, 'lock', id, function (m) {\n            var errorFn = getProp(r, k, 'errorFn');\n\n            if (error && typeof errorFn === 'function') {\n              setTimeout(function () {\n                return errorFn(m, error);\n              }, 0);\n            }\n\n            var recoverResult = getProp(m, k, 'recoverResult');\n\n            if (error && recoverResult === undefined) {\n              return handleError(m, k, error);\n            } else {\n              m = setStatus(m, k, 'ok');\n              return getProp(m, k, 'successFn')(m, error ? recoverResult : result);\n            }\n          });\n        }, 0);\n      });\n    } else if (getStatus(r, k) === 'waiting') {\n      if (getProp(r, k, 'waitFn')(r)) {\n        var conditionFn = getProp(r, k, 'conditionFn');\n        r = setStatus(r, k, !conditionFn || conditionFn(r) ? 'pending' : 'no');\n      }\n    }\n\n    return r;\n  }, m);\n};\n\nvar go = exports.go = function go(id) {\n  (0, _index2.observe)('sync', id, function (m) {\n    setTimeout(function () {\n      return (0, _index2.swap)(_index2.updateEntity, 'lock', id, process, id);\n    }, 0);\n  });\n};\n\nfunction isSuccess(m, key) {\n  return getStatus(m, key) === 'ok';\n}\n\nfunction isDone(m) {\n  var keys = findKeys(get(m, [], (0, _immutable.Map)()));\n  return keys.length > 0 && keys.reduce(function (r, k) {\n    return r && !isLoading(m, k);\n  }, true);\n}\n\nfunction hasError(m) {\n  var excludeKeys = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n\n  var keys = findKeys(removeKeys(get(m, [], (0, _immutable.Map)()), excludeKeys));\n  return keys.length > 0 && keys.reduce(function (r, k) {\n    return r || getStatus(m, k) === 'error';\n  }, false);\n}\n\nfunction isLoading(m, key) {\n  return ['loading', 'pending', 'waiting'].indexOf(getStatus(m, key)) > -1;\n}\n\nfunction handleError(m, key, error) {\n  var result = setStatus(m, key, 'error');\n\n  // TODO: this should be configurable for each sync\n  if (key !== 'sso') {\n    var stopError = new Error('An error occurred when fetching ' + key + ' data for Lock: ' + error.message);\n    stopError.code = 'sync';\n    stopError.origin = error;\n    result = l.stop(result, stopError);\n  }\n\n  return result;\n}\n"]},"metadata":{},"sourceType":"script"}